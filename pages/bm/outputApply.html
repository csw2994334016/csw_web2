---
layout: base_page
---
<div class="pos-absolute flex-row" style="top: 0; right: 0;bottom: 0;left: 0; overflow-y: scroll;overflow-x: hidden">
    <!--主Table-->
    <div id="mainDiv" class="p-15 w-full">
        <div id="inputForm" class="form-horizontal bg-white r-5 m-b-10 p-t-10 p-r-10 p-b-1">
            <div class="form-group m-b-10 " style="margin-left: 0; margin-right: 0;">
                <label for="proposer" class="col-sm-1 control-label">申请人</label>
                <div class="col-sm-3" style="padding-right: 0; padding-left: 0;">
                    <select id="proposer" name="proposer" class="selectpicker form-control show-tick h-30"
                            data-live-search="true" title="请选择申请人">
                    </select>
                </div>
                <label for="approver1" class="col-sm-1 control-label">审批人</label>
                <div class="col-sm-3" style="padding-right: 0; padding-left: 0;">
                    <select id="approver1" name="approver1" class="selectpicker form-control show-tick h-30"
                            data-live-search="true" title="请选择审批人">
                    </select>
                </div>
                <label for="state" class="col-sm-1 control-label">状态</label>
                <div class="col-sm-3" style="padding-right: 0; padding-left: 0;">
                    <select id="state" name="state" class="selectpicker form-control show-tick h-30"
                            data-live-search="true" title="请选择状态">
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-left: 0; margin-right: 0;">
                <label for="startTime" class="col-sm-1 control-label">开始时间</label>
                <div class="col-sm-3" style="padding-right: 0;padding-left: 0;">
                    <input type="date" class="form-control h-30" name="startTime" id="startTime"
                           placeholder="请输入开始时间"/>
                </div>
                <label for="endTime" class="col-sm-1 control-label">结束时间</label>
                <div class="col-sm-3" style="padding-right: 0;padding-left: 0;">
                    <input type="date" class="form-control h-30" name="endTime" id="endTime"
                           placeholder="请输入结束时间"/>
                </div>
                <label class="col-sm-1 control-label"></label>
                <div class="col-sm-3" style="padding-right: 0;padding-left: 0;">
                    <button id="search" type="button" class="btn btn-primary">
                        <i class="glyphicon glyphicon-search"></i> 查询
                    </button>
                    <button id="reset1" type="button" class="btn btn-warning">
                        <i class="glyphicon glyphicon-remove-sign"></i> 重置
                    </button>
                </div>
            </div>
        </div>
        <div class="bg-white p-l-10 p-r-10 b-r-5">
            <table id="myTable" class="table table-hover"></table>
        </div>
        <div class="container" style="width: 100%;">
            <div id="toolbar">
                <button id="add" type="button" class="btn btn-default" data-toggle="modal">
                    <i class="glyphicon glyphicon-plus"></i> 新增
                </button>
                <button id="edit" type="button" class="btn btn-default" data-toggle="modal" disabled>
                    <i class="glyphicon glyphicon-edit"></i> 修改
                </button>
                <button id="delete" type="button" class="btn btn-default" disabled>
                    <i class="glyphicon glyphicon-trash"></i> 废除
                </button>
                <button id="withdraw" type="button" class="btn btn-default" disabled>
                    <i class="glyphicon glyphicon-share-alt"></i> 撤回申请
                </button>
                <button id="submit" type="button" class="btn btn-default" disabled>
                    <i class="glyphicon glyphicon-send"></i> 提交申请
                </button>
                <button id="lookDetail" type="button" class="btn btn-default m-l-5" disabled>
                    <i class="glyphicon glyphicon-search"></i> 查看明细
                </button>
            </div>
        </div>
    </div>

    <!--添加和修改页面Table-->
    <div id="allocateDiv" class="p-15 w-full tableDisplay pos-absolute"
         style="top: 0; right: 0;bottom: 0;left: 100%;z-index: 100">
        <div id="applyForm" class="form-horizontal bg-white r-5 m-b-10 p-t-10 p-r-10 p-b-1">
            <div class="form-group" hidden>
                <label for="id" class="col-sm-2 control-label">ID</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="id" name="id" placeholder="" readonly/>
                </div>
            </div>
            <div class="form-group m-b-10" style="margin-left: 0; margin-right: 0;">
                <label for="whName" class="col-sm-1 control-label">仓库</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <select id="whName" name="whName" class="selectpicker form-control show-tick h-30"
                            data-live-search="true"
                            title="请选择仓库">
                    </select>
                </div>
                <label for="approver" class="col-sm-1 control-label">审批人</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <select id="approver" name="approver" class="selectpicker form-control show-tick h-30"
                            data-live-search="true"
                            title="请选择审批人">
                    </select>
                </div>
                <label for="banJiName" class="col-sm-1 control-label">班级</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <select id="banJiName" name="banJiName" class="selectpicker form-control show-tick h-30"
                            data-live-search="true"
                            title="请选择班级">
                    </select>
                </div>
                <label for="projectName" class="col-sm-1 control-label">项目</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <select id="projectName" name="projectName" class="selectpicker form-control show-tick h-30"
                            data-live-search="true" title="请选择项目">
                    </select>
                </div>
            </div>
            <div class="form-group m-b-10" style="margin-left: 0; margin-right: 0;">
                <label for="sku_skuAmount" class="col-sm-1 control-label">物料</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <select id="sku_skuAmount" name="sku_skuAmount" class="selectpicker form-control show-tick h-30"
                            data-live-search="true" title="请选择物料名称-规格/型号">
                    </select>
                </div>
                <label for="skuAmount" class="col-sm-1 control-label">库存量</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <input type="text" id="skuAmount" name="skuAmount" class="form-control h-30" readonly
                           placeholder="请输入库存量"/>
                </div>
                <label for="outNumber" class="col-sm-1 control-label">领用量</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <input type="text" id="outNumber" name="outNumber" class="form-control h-30" placeholder="请输入领用量"/>
                </div>
                <label for="remark" class="col-sm-1 control-label">备注</label>
                <div class="col-sm-2" style="padding-right: 0; padding-left: 0;">
                    <textarea class="form-control h-30" rows="1" id="remark" name="remark"
                              placeholder="请输入备注（200字内）"></textarea>
                </div>
            </div>
        </div>
        <div class=" bg-white p-l-10 p-r-10 b-r-5">
            <table id="outputTable" class="table table-hover"></table>
        </div>
        <div class="container" style="width: 100%;">
            <div id="outputToolbar">
                <button id="return1" type="button" class="btn btn-default">
                    <i class="glyphicon glyphicon-arrow-left"></i> 返回
                </button>
                <button id="addToTable" type="button" class="btn btn-primary">
                    <i class="glyphicon glyphicon-plus"></i> 添加
                </button>
                <button id="reset" type="button" class="btn btn-warning">
                    <i class="glyphicon glyphicon-cog"></i> 重置
                </button>
                <button id="deleteOutput" type="button" class="btn btn-default" disabled>
                    <i class="glyphicon glyphicon-trash"></i> 删除
                </button>
                <button id="addOrEditOutput" type="button" class="btn btn-primary">
                    <i class="glyphicon glyphicon-floppy-disk"></i> 保存
                </button>
            </div>
        </div>
    </div>

    <!--查看详情页面Table-->
    <div id="allocateDiv1" class="p-15 w-full tableDisplay pos-absolute"
         style="top: 0; right: 0;bottom: 0;left: 100%;z-index: 100">
        <div class=" bg-white p-l-10 p-r-10 b-r-5">
            <table id="outputTable1" class="table table-hover"></table>
        </div>
        <div class="container" style="width: 100%;">
            <div id="outputToolbar1">
                <button id="return2" type="button" class="btn btn-default">
                    <i class="glyphicon glyphicon-arrow-left"></i> 返回
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var Table = {
        api: '/api/bm/outputApplies',
        tableId: "myTable",
        toolbarId: "toolbar",
        bsTable: null,
        bsModal: null
    };
    Table.initColumn = function () {
        var columns = [
            {field: 'state1', checkbox: true, align: 'center', valign: 'middle'},
            {title: 'ID', field: 'id', align: 'center', visible: false},
            {title: '出库单号', field: 'outputNo', align: 'center', width: '10%', sortable: true},
            {title: '仓库名称', field: 'whName', align: 'center'},
            {title: '申请人', field: 'proposer', align: 'center'},
            {title: '审批人', field: 'approver', align: 'center'},
            {title: '班级', field: 'banJiName', align: 'center'},
            {title: '项目', field: 'projectName', align: 'center'},
            {title: '状态', field: 'state', align: 'center', width: '10%', formatter: BSTable.prototype.stateFormatter},
            {
                title: '申请时间',
                field: 'createTime',
                align: 'center',
                width: '10%',
                cellStyle: BSTable.prototype.formatTableCell
            },
            {title: '备注', field: 'remark', align: 'center', cellStyle: BSTable.prototype.formatTableCell}
        ];
        return columns;
    };

    var OutputTable = {
        api: '/api/bm/outputApplies/details',
        tableId: "outputTable",
        toolbarId: "outputToolbar",
        bsTable: null,
        bsModal: null
    };
    OutputTable.initColumn = function () {
        var columns = [
            {field: 'state', checkbox: true, align: 'center', valign: 'middle'},
            {title: 'ID', field: 'id', align: 'center', visible: false},
            // {title: '出库单号', field: 'output.outputNo', align: 'center', width: '10%', sortable: true},
            // {title: '仓库名称', field: 'output.whName', align: 'center'},
            {title: '物料编号', field: 'sku', align: 'center', visible: false},
            {title: '物料名称', field: 'skuDesc', align: 'center'},
            {title: '规格/类型', field: 'spec', align: 'center'},
            {
                title: '出库数量', field: 'outNumber', align: 'center', editable: {
                    type: 'text',
                    title: '请填写出库数量',
                    validate: function (v) {
                        if (!v) {
                            return '出库数量不能为空'
                        } else if (!CSW.validatePositiveFloatNum(v)) {
                            return '出库数量只能是数字'
                        }
                    }
                }
            }
        ];
        return columns;
    };

    //查看详情
    var OutputTable1 = {
        api: '/api/bm/outputApplies/details',
        tableId: "outputTable1",
        toolbarId: "outputToolbar1",
        bsTable: null,
        bsModal: null
    };
    OutputTable1.initColumn = function () {
        var columns = [
            {field: 'state', checkbox: true, align: 'center', valign: 'middle'},
            {title: '出库单号', field: 'output.outputNo', align: 'center', sortable: true, width: '10%'},
            {title: '仓库名称', field: 'output.whName', align: 'center'},
            {title: '物料编号', field: 'sku', align: 'center'},
            {title: '物料名称', field: 'skuDesc', align: 'center'},
            {title: '规格/类型', field: 'spec', align: 'center'},
            {title: '申请数量', field: 'outNumber', align: 'center'},
            {title: '领出数量', field: 'actualNumber', align: 'center'},
            {title: '归还数量', field: 'returnNumber', align: 'center'}
        ];
        return columns;
    };

    //执行方法
    $(function () {

        //初始化添加模态框方法
        var fields = ['id', 'whName', 'approver', 'banJiName', 'projectName', 'sku_skuAmount', 'skuAmount', 'outNumber', 'remark'];
        var bsModal = new BSModal(Table.api);
        bsModal.setFields(fields);
        bsModal.setModal('outputModal', 'applyForm', 'addOrEditOutput', 'id');
        bsModal = bsModal.init();
        //初始化工具条
        var toolbar = new Toolbar(Table.toolbarId);
        toolbar.setBntName('add', 'delete', 'edit');
        toolbar = toolbar.init();
        //初始化表格
        var bsTable = new BSTable(Table.tableId, Table.toolbarId, CSW.getUrl(Table.api), Table.initColumn());
        bsTable = bsTable.init();
        bsTable.bindEvents(toolbar, bsModal, bsTable);
        bsTable.tbInstance.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table refresh.bs.table', function () {
            $('#submit').prop('disabled', !bsTable.getIdSelections().length);
            $('#withdraw').prop('disabled', !bsTable.getIdSelections().length);
            $("#lookDetail").prop('disabled', bsTable.getIdSelections().length > 1 || !bsTable.getIdSelections().length);
        });

        var outputTable = new BSTable(OutputTable.tableId, OutputTable.toolbarId, CSW.getUrl(OutputTable.api), OutputTable.initColumn());
        outputTable.setOnEditableSave(function () {

        });
        outputTable = outputTable.init();
        outputTable.tbInstance.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table', function () {
            $('#deleteOutput').prop('disabled', !outputTable.getIdSelections().length);
        });

        var outputTable1 = new BSTable(OutputTable1.tableId, OutputTable1.toolbarId, CSW.getUrl(OutputTable1.api), OutputTable1.initColumn());
        outputTable1 = outputTable1.init();

        //查询条件
        //申请人
        $("#proposer").empty();
        var ajax = new $ax('/api/sys/users/findByRoleType', function (data) {
            if (data.code === "0000") {
                var items = data.data;
                // console.log(items);
                var select = $("#proposer");
                select.append("<option value='" + '' + "'>" + '' + "</option>");
                for (var i = 0; i < items.length; i++) {
                    select.append("<option value='" + items[i].username + "'>" + items[i].username + "</option>");
                }
                select.selectpicker('val', '');
                select.selectpicker('refresh');
            } else if (data.code === "0002") {
                CSW.error(CSW.getFail + data.msg);
            } else {
                CSW.error(CSW.unknowCode + data.code);
            }
        }, function (data) {
            CSW.error(CSW.requestFail + data.msg);
        });
        ajax.type = "get";
        ajax.start();
        //审批人
        $("#approver1").empty();
        ajax = new $ax('/api/sys/users', function (data) {
            if (data.code === "0000") {
                var items = data.data;
                // console.log(items);
                var select = $("#approver1");
                select.append("<option value='" + '' + "'>" + '' + "</option>");
                for (var i = 0; i < items.length; i++) {
                    select.append("<option value='" + items[i].username + "'>" + items[i].username + "</option>");
                }
                select.selectpicker('val', '');
                select.selectpicker('refresh');
            } else if (data.code === "0002") {
                CSW.error(CSW.getFail + data.msg);
            } else {
                CSW.error(CSW.unknowCode + data.code);
            }
        }, function (data) {
            CSW.error(CSW.requestFail + data.msg);
        });
        ajax.type = "get";
        ajax.start();
        //状态
        $("#state").empty();
        ajax = new $ax('/api/bm/outputApplies/status', function (data) {
            if (data.code === "0000") {
                var items = data.data;
                // console.log(items);
                var select = $("#state");
                select.append("<option value='" + '' + "'>" + '' + "</option>");
                for (var i = 0; i < items.length; i++) {
                    select.append("<option value='" + items[i].code + "'>" + items[i].desc + "</option>");
                }
                select.selectpicker('val', '');
                select.selectpicker('refresh');
            } else if (data.code === "0002") {
                CSW.error(CSW.getFail + data.msg);
            } else {
                CSW.error(CSW.unknowCode + data.code);
            }
        }, function (data) {
            CSW.error(CSW.requestFail + data.msg);
        });
        ajax.type = "get";
        ajax.start();

        $("#add").click(function () {
            $("#whName").removeAttr("disabled");
            bsModal.clearForm();
            outputTable.tbInstance.bootstrapTable('removeAll');
            //库房下拉框
            $("#whName").empty();
            var ajax = new $ax('/api/basic/warehouses', function (data) {
                if (data.code === "0000") {
                    var items = data.data;
                    // console.log(items);
                    var select = $("#whName");
                    for (var i = 0; i < items.length; i++) {
                        select.append("<option value='" + items[i].whName + "'>" + items[i].whName + "</option>");
                    }
                    select.selectpicker('val', '');
                    select.selectpicker('refresh');
                } else if (data.code === "0002") {
                    CSW.error(CSW.getFail + data.msg);
                } else {
                    CSW.error(CSW.unknowCode + data.code);
                }
            }, function (data) {
                CSW.error(CSW.requestFail + data.msg);
            });
            ajax.type = "get";
            ajax.start();
            //审批人
            $("#approver").empty();
            ajax = new $ax('/api/sys/users', function (data) {
                if (data.code === "0000") {
                    var items = data.data;
                    // console.log(items);
                    var select = $("#approver");
                    for (var i = 0; i < items.length; i++) {
                        select.append("<option value='" + items[i].username + "'>" + items[i].username + "</option>");
                    }
                    select.selectpicker('val', '');
                    select.selectpicker('refresh');
                } else if (data.code === "0002") {
                    CSW.error(CSW.getFail + data.msg);
                } else {
                    CSW.error(CSW.unknowCode + data.code);
                }
            }, function (data) {
                CSW.error(CSW.requestFail + data.msg);
            });
            ajax.type = "get";
            ajax.start();
            //班级
            $("#banJiName").empty();
            ajax = new $ax('/api/basic/banJis', function (data) {
                if (data.code === "0000") {
                    var items = data.data;
                    // console.log(items);
                    var select = $("#banJiName");
                    for (var i = 0; i < items.length; i++) {
                        select.append("<option value='" + items[i].banJiName + "'>" + items[i].banJiName + "</option>");
                    }
                    select.selectpicker('val', '');
                    select.selectpicker('refresh');
                } else if (data.code === "0002") {
                    CSW.error(CSW.getFail + data.msg);
                } else {
                    CSW.error(CSW.unknowCode + data.code);
                }
            }, function (data) {
                CSW.error(CSW.requestFail + data.msg);
            });
            ajax.type = "get";
            ajax.start();
            //项目
            $("#projectName").empty();
            ajax = new $ax('/api/basic/projects', function (data) {
                if (data.code === "0000") {
                    var items = data.data;
                    // console.log(items);
                    var select = $("#projectName");
                    for (var i = 0; i < items.length; i++) {
                        select.append("<option value='" + items[i].projectName + "'>" + items[i].projectName + "</option>");
                    }
                    select.selectpicker('val', '');
                    select.selectpicker('refresh');
                } else if (data.code === "0002") {
                    CSW.error(CSW.getFail + data.msg);
                } else {
                    CSW.error(CSW.unknowCode + data.code);
                }
            }, function (data) {
                CSW.error(CSW.requestFail + data.msg);
            });
            ajax.type = "get";
            ajax.start();
            // bsModal.open("新增领料申请");

            $("#allocateDiv").css("display", "block");
            setTimeout(function () {
                $("#allocateDiv").css("transform", "translate(-100%, 0%)");
            }, 300);
            setTimeout(function () {
                $("#mainDiv").addClass("display-none").removeClass('display-block');
            }, 600);

        });
        //物料汇总信息
        $('#whName').change(function () {
            var items = outputTable.tbInstance.bootstrapTable('getData');
            if (items.length > 0) {
                CSW.confirm("修改库房信息会清空表格中的数据！", function (result) {
                    if (result) {
                        outputTable.tbInstance.bootstrapTable('removeAll');
                    }
                });
            }
            $('#skuAmount').val('');
            var whName = $('#whName').val();
            $("#sku_skuAmount").empty();
            var ajax = new $ax('/api/bm/inventories/whName', function (data) {
                if (data.code === "0000") {
                    var items = data.data;
                    // console.log(items);
                    var select = $("#sku_skuAmount");
                    for (var i = 0; i < items.length; i++) {
                        var skuDesc_spec = items[i].skuDesc + "-" + items[i].spec;
                        var sku_skuAmount = items[i].sku + "-" + items[i].skuAmount;
                        select.append("<option value='" + sku_skuAmount + "'>" + skuDesc_spec + "</option>");
                    }
                    select.selectpicker('val', '');
                    select.selectpicker('refresh');
                } else if (data.code === "0002") {
                    CSW.error(CSW.getFail + data.msg);
                } else {
                    CSW.error(CSW.unknowCode + data.code);
                }
            }, function (data) {
                CSW.error(CSW.requestFail + data.msg);
            });
            ajax.set('whName', whName);
            ajax.type = "POST";
            ajax.start();
        });
        //物料库存量
        $("#sku_skuAmount").change(function () {
            var sku_skuAmount = $('#sku_skuAmount').val();
            $('#skuAmount').val(sku_skuAmount.split('-')[1])
        });
        //验证领用量数值
        // $('#outNumber').blur(function () {
        //     var amount = $('#outNumber').val();
        //     if (!CSW.validatePositiveFloatNum(amount)) {
        //         CSW.error("领用数量只能是大于0的数字");
        //     }
        // });
        $('#addToTable').click(function () {
            bsModal.clearModalData();
            bsModal.collectModalData();
            var modalData = bsModal.modalData;
            modalData['sku'] = modalData.sku_skuAmount.split('-')[0];
            var skuDesc_spec = $('#sku_skuAmount').find("option:selected").text();
            modalData['skuDesc'] = skuDesc_spec.split('-')[0];
            modalData['spec'] = skuDesc_spec.split('-')[1];
            console.log(modalData);
            //验证必要字段
            var amount = $('#outNumber').val();
            if (modalData.whName === "") {
                CSW.error("库房名称不可以为空");
            } else if (modalData.sku === "") {
                CSW.error("物料名称-规格/类型不可以为空")
            } else if (modalData.approver === "") {
                CSW.error("审批人不可以为空");
            } else if (modalData.banJiName === "") {
                CSW.error("班级不可以为空");
            } else if (modalData.projectName === "") {
                CSW.error("项目不可以为空");
            } else if (typeof modalData.skuDesc === "undefined" || typeof modalData.spec === "undefined") {
                CSW.error("物料名称-规格/类型不可以为空")
            } else if (modalData.outNumber === "") {
                CSW.error("领用量不可以为空");
            } else if (!CSW.validatePositiveFloatNum(amount)) {
                CSW.error("领用数量只能是大于0的数字");
            } else {
                var outNum = parseFloat(String(modalData.outNumber));
                var skuNum = parseFloat($('#skuAmount').val());
                if (outNum <= skuNum) {
                    var include = true;
                    var items = outputTable.tbInstance.bootstrapTable('getData');
                    for (var i in items) {
                        if (items[i].sku === modalData.sku) {
                            include = false;
                        }
                    }
                    if (include) {
                        modalData.id = "";
                        outputTable.tbInstance.bootstrapTable('append', modalData);
                    } else {
                        CSW.error("表格中存在该物料，请在原记录中修改");
                    }
                } else {
                    CSW.error("领用数量不能大于库存量");
                }
            }
        });
        $('#reset').click(function () {
            bsModal.clearForm();
            $('#whName').selectpicker('val', '');
            $('#approver').selectpicker('val', '');
            $('#banJiName').selectpicker('val', '');
            $('#projectName').selectpicker('val', '');
            $('#sku_skuAmount').selectpicker('val', '');
            outputTable.tbInstance.bootstrapTable('removeAll');
        });
        $('#deleteOutput').click(function () {
            var items = outputTable.getItemSelections();
            // console.log(items);
            if (items.length >= 1) {
                var str = items.length > 1 ? CSW.batchConfirmInfo : "";
                CSW.confirm(CSW.confirmInfo + str, function (result) {
                    if (result) {
                        var objects = [];
                        var skus = [];
                        for (var i in items) {
                            var object = {};
                            if (items[i].id !== null && items[i].id !== '') {
                                object["id"] = parseInt(items[i].id);
                                objects.push(object);
                            } else {
                                skus.push(items[i].sku);
                            }
                        }
                        // console.log("ids: " + objects);
                        if (objects.length > 0) {
                            var ajax = new $ax(bsModal.api + "/details/batch", function (data) {
                                if (data.code === "0000") {
                                    CSW.success(CSW.deleteOk);
                                    outputTable.refresh();
                                } else if (data.code === "0002") {
                                    CSW.error(CSW.deleteFail + data.msg);
                                } else {
                                    CSW.error(CSW.unknowCode + data.code);
                                }
                            }, function (data) {
                                CSW.error(CSW.requestFail + data.msg);
                            });
                            ajax.type = "DELETE";
                            ajax.data = objects;
                            ajax.start();
                        }
                        if (skus.length > 0) { //前端删除
                            outputTable.tbInstance.bootstrapTable('remove', {field: 'sku', values: skus});
                        }
                    }
                });
            } else {
                CSW.info(CSW.selectTip);
            }
        });

        $("#edit").click(function () {
            var itemSelections = bsTable.getItemSelections();
            if (itemSelections.length === 1) {
                if (itemSelections[0].state === 1) {
                    //库房下拉框不可用
                    $('#id').val(itemSelections[0].id);
                    var whName = itemSelections[0].whName;
                    $("#whName").append("<option value='" + whName + "'>" + whName + "</option>");
                    $("#whName").selectpicker('val', whName);
                    $("#whName").selectpicker('refresh');
                    $("#whName").attr("disabled", "disabled");
                    //审批人
                    $("#approver").empty();
                    ajax = new $ax('/api/sys/users', function (data) {
                        if (data.code === "0000") {
                            var items = data.data;
                            // console.log(items);
                            var select = $("#approver");
                            for (var i = 0; i < items.length; i++) {
                                select.append("<option value='" + items[i].username + "'>" + items[i].username + "</option>");
                            }
                            select.selectpicker('val', itemSelections[0].approver);
                            select.selectpicker('refresh');
                        } else if (data.code === "0002") {
                            CSW.error(CSW.saveFail + data.msg);
                        } else {
                            CSW.error(CSW.unknowCode + data.code);
                        }
                    }, function (data) {
                        CSW.error(CSW.requestFail + data.msg);
                    });
                    ajax.type = "get";
                    ajax.start();
                    $("#approver").selectpicker('val', itemSelections[0].approver);
                    $("#approver").selectpicker('refresh');
                    //班级
                    $("#banJiName").empty();
                    ajax = new $ax('/api/basic/banJis', function (data) {
                        if (data.code === "0000") {
                            var items = data.data;
                            // console.log(items);
                            var select = $("#banJiName");
                            for (var i = 0; i < items.length; i++) {
                                select.append("<option value='" + items[i].banJiName + "'>" + items[i].banJiName + "</option>");
                            }
                            select.selectpicker('val', itemSelections[0].banJiName);
                            select.selectpicker('refresh');
                        } else if (data.code === "0002") {
                            CSW.error(CSW.saveFail + data.msg);
                        } else {
                            CSW.error(CSW.unknowCode + data.code);
                        }
                    }, function (data) {
                        CSW.error(CSW.requestFail + data.msg);
                    });
                    ajax.type = "get";
                    ajax.start();
                    $("#banJiName").selectpicker('val', itemSelections[0].banJiName);
                    $("#banJiName").selectpicker('refresh');
                    //项目
                    $("#projectName").empty();
                    ajax = new $ax('/api/basic/projects', function (data) {
                        if (data.code === "0000") {
                            var items = data.data;
                            // console.log(items);
                            var select = $("#projectName");
                            for (var i = 0; i < items.length; i++) {
                                select.append("<option value='" + items[i].projectName + "'>" + items[i].projectName + "</option>");
                            }
                            select.selectpicker('val', itemSelections[0].projectName);
                            select.selectpicker('refresh');
                        } else if (data.code === "0002") {
                            CSW.error(CSW.saveFail + data.msg);
                        } else {
                            CSW.error(CSW.unknowCode + data.code);
                        }
                    }, function (data) {
                        CSW.error(CSW.requestFail + data.msg);
                    });
                    ajax.type = "get";
                    ajax.start();
                    $("#projectName").selectpicker('val', itemSelections[0].projectName);
                    $("#projectName").selectpicker('refresh');
                    //物料汇总信息
                    $('#skuAmount').val('');
                    $("#sku_skuAmount").empty();
                    var ajax = new $ax('/api/bm/inventories/whName', function (data) {
                        if (data.code === "0000") {
                            var items = data.data;
                            // console.log(items);
                            var select = $("#sku_skuAmount");
                            for (var i = 0; i < items.length; i++) {
                                var skuDesc_spec = items[i].skuDesc + "-" + items[i].spec;
                                var sku_skuAmount = items[i].sku + "-" + items[i].skuAmount;
                                select.append("<option value='" + sku_skuAmount + "'>" + skuDesc_spec + "</option>");
                            }
                            select.selectpicker('val', '');
                            select.selectpicker('refresh');
                        } else if (data.code === "0002") {
                            CSW.error(CSW.saveFail + data.msg);
                        } else {
                            CSW.error(CSW.unknowCode + data.code);
                        }
                    }, function (data) {
                        CSW.error(CSW.requestFail + data.msg);
                    });
                    ajax.set('whName', whName);
                    ajax.type = "POST";
                    ajax.start();
                    //获取出库单详情
                    var queryData = {};
                    queryData['id'] = parseInt(itemSelections[0].id);
                    outputTable.refresh({query: queryData});
                    outputTable.setRefreshParams({query: queryData});
                    // bsModal.open("编辑领料申请");

                    $("#allocateDiv").css("display", "block");
                    setTimeout(function () {
                        $("#allocateDiv").css("transform", "translate(-100%, 0%)");
                    }, 300);
                    setTimeout(function () {
                        $("#mainDiv").addClass("display-none").removeClass('display-block');
                    }, 600);
                } else {
                    CSW.error("只有草稿状态下才可以修改");
                }
            } else if (itemSelections.length > 1) {
                CSW.info(CSW.selectOneTip);
            }
        });
        $('#addOrEditOutput').click(function () {
            bsModal.clearModalData();
            bsModal.collectModalData();
            var modalData = bsModal.modalData;
            var items = outputTable.getItemSelections();
            // console.log(items);
            if (items.length > 0) {
                var url = bsModal.api;
                var type = "POST";
                if (bsModal.modalData !== null && bsModal.modalData[bsModal.idName] !== '') {
                    url = url + "/" + bsModal.modalData[bsModal.idName];
                    type = "PUT";
                }
                var ajax = new $ax(url, function (data) {
                    if (data.code === "0000") {
                        CSW.success(CSW.saveOk);
                        $("#allocateDiv").css("transform", "translate(0%, 0%)");
                        setTimeout(function () {
                            $("#mainDiv").addClass("display-block").removeClass('display-none');
                        }, 100);
                        setTimeout(function () {
                            $("#allocateDiv").css("display", "none");
                        }, 200);
                        bsModal.close();
                        bsTable.refresh();
                    } else if (data.code === "0002") {
                        CSW.error(CSW.saveFail + data.msg);
                    } else {
                        CSW.error(CSW.unknowCode + data.code);
                    }
                }, function (data) {
                    CSW.error(CSW.requestFail + data.msg);
                });
                modalData['outputDetailParamList'] = items;
                ajax.setData(modalData); //提交的Json数据对象
                ajax.type = type;
                ajax.start();
            }
        });

        $('#delete').click(function () {
            var ok = true;
            var items = bsTable.getItemSelections();
            for (var i in items) {
                if (items[i].state !== 1) {
                    ok = false;
                }
            }
            if (ok) {
                var ids = bsTable.getIdSelections();
                // console.log("ids: " + ids);
                if (ids.length >= 1) {
                    var str = ids.length > 1 ? CSW.batchConfirmInfo : "";
                    CSW.confirm(CSW.confirmInfo + str, function (result) {
                        if (result) {
                            var objects = [];
                            for (var i in ids) {
                                var object = {};
                                object["id"] = parseInt(ids[i]);
                                objects.push(object);
                            }
                            // console.log("ids: " + objects);
                            var ajax = new $ax(bsModal.api + "/batch", function (data) {
                                if (data.code === "0000") {
                                    CSW.success(CSW.deleteOk);
                                    bsTable.refresh();
                                } else if (data.code === "0002") {
                                    CSW.error(CSW.deleteFail + data.msg);
                                } else {
                                    CSW.error(CSW.unknowCode + data.code);
                                }
                            }, function (data) {
                                CSW.error(CSW.requestFail + data.msg);
                            });
                            ajax.type = "DELETE";
                            ajax.data = objects;
                            ajax.start();
                        }
                    });
                } else {
                    CSW.info(CSW.selectTip);
                }
            } else {
                CSW.error("只有草稿状态下才可以作废");
            }
        });
        $('#submit').click(function () {
            var ok = true;
            var items = bsTable.getItemSelections();
            for (var i in items) {
                if (items[i].state !== 1) {
                    ok = false;
                }
            }
            if (ok) {
                var ids = bsTable.getIdSelections();
                // console.log("ids: " + ids);
                if (ids.length >= 1) {
                    var str = ids.length > 1 ? "请注意是批量提交申请！" : "";
                    CSW.confirm(CSW.confirmInfo + str, function (result) {
                        if (result) {
                            var objects = [];
                            for (var i in ids) {
                                var object = {};
                                object["id"] = parseInt(ids[i]);
                                objects.push(object);
                            }
                            // console.log("ids: " + objects);
                            var ajax = new $ax(bsModal.api + "/submit", function (data) {
                                if (data.code === "0000") {
                                    CSW.success(CSW.saveOk);
                                    bsTable.refresh();
                                } else if (data.code === "0002") {
                                    CSW.error(CSW.saveFail + data.msg);
                                } else {
                                    CSW.error(CSW.unknowCode + data.code);
                                }
                            }, function (data) {
                                CSW.error(CSW.requestFail + data.msg);
                            });
                            ajax.type = "POST";
                            ajax.data = objects;
                            ajax.start();
                        }
                    });
                } else {
                    CSW.info(CSW.selectTip);
                }
            } else {
                CSW.error("只有草稿状态下才可以提交申请");
            }
        });
        $('#withdraw').click(function () {
            var ok = true;
            var items = bsTable.getItemSelections();
            for (var i in items) {
                if (items[i].state !== 2) {
                    ok = false;
                }
            }
            if (ok) {
                var ids = bsTable.getIdSelections();
                // console.log("ids: " + ids);
                if (ids.length >= 1) {
                    var str = ids.length > 1 ? "请注意是批量撤回申请！" : "";
                    CSW.confirm(CSW.confirmInfo + str, function (result) {
                        if (result) {
                            var objects = [];
                            for (var i in ids) {
                                var object = {};
                                object["id"] = parseInt(ids[i]);
                                objects.push(object);
                            }
                            // console.log("ids: " + objects);
                            var ajax = new $ax(bsModal.api + "/withdraw", function (data) {
                                if (data.code === "0000") {
                                    CSW.success(CSW.saveOk);
                                    bsTable.refresh();
                                } else if (data.code === "0002") {
                                    CSW.error(CSW.saveFail + data.msg);
                                } else {
                                    CSW.error(CSW.unknowCode + data.code);
                                }
                            }, function (data) {
                                CSW.error(CSW.requestFail + data.msg);
                            });
                            ajax.type = "POST";
                            ajax.data = objects;
                            ajax.start();
                        }
                    });
                } else {
                    CSW.info(CSW.selectTip);
                }
            } else {
                CSW.error("只有申请状态下才可以撤回申请");
            }
        });

        $("#lookDetail").click(function () {
            var itemSelections = bsTable.getItemSelections();
            if (itemSelections.length === 1) {
                var queryData = {};
                queryData['id'] = parseInt(itemSelections[0].id);
                outputTable1.refresh({query: queryData});
                outputTable1.setRefreshParams({query: queryData});
                $("#allocateDiv1").css("display", "block");
                setTimeout(function () {
                    $("#allocateDiv1").css("transform", "translate(-100%, 0%)");
                }, 100);
                setTimeout(function () {
                    $("#mainDiv").addClass("display-none").removeClass('display-block');
                }, 600);
            } else if (itemSelections.length > 1) {
                CSW.info(CSW.selectOneTip);
            }
        });

        $("#return1").click(function () {
            $("#allocateDiv").css("transform", "translate(0%, 0%)");
            setTimeout(function () {
                $("#mainDiv").addClass("display-block").removeClass('display-none');
            }, 100);
            setTimeout(function () {
                $("#allocateDiv").css("display", "none");
            }, 200);
        });
        $("#return2").click(function () {
            $("#allocateDiv1").css("transform", "translate(0%, 0%)");
            setTimeout(function () {
                $("#mainDiv").addClass("display-block").removeClass('display-none');
            }, 100);
            setTimeout(function () {
                $("#allocateDiv1").css("display", "none");
            }, 200);
        });

        $('#reset1').click(function () {
            $('#proposer').selectpicker('val', '');
            $('#approver1').selectpicker('val', '');
            $('#state').selectpicker('val', '');
            $('#startTime').val('');
            $('#endTime').val('');
        });

        $("#search").click(function () {
            var queryData = {};
            queryData['proposer'] = $('#proposer').val();
            queryData['approver'] = $('#approver1').val();
            queryData['state'] = $('#state').val();
            queryData['startTime'] = $('#startTime').val();
            queryData['endTime'] = $('#endTime').val();
            bsTable.refresh({query: queryData});
            bsTable.setRefreshParams({query: queryData});
        });
    });
</script>
