---
layout: base_page
---
<div class="pos-absolute over-hidden" style="top: 0; right: 0;bottom: 0;left: 0">
    <!--主Table-->
    <div id="mainDiv" class="p-15">
        <div class="bg-white p-l-10 p-r-10 b-r-5">
            <table id="myTable" class="table table-hover"></table>
        </div>
    </div>
    <div class="container" style="width: 100%;">
        <div id="toolbar">
            <button id="allocate" type="button" class="btn btn-default" disabled>
                <i class="glyphicon glyphicon-screenshot"></i> 分配策略
            </button>
            <button id="giveBack" type="button" class="btn btn-default" disabled>
                <i class="glyphicon glyphicon-log-out"></i> 退还
            </button>
        </div>
    </div>
    <!--分配策略Table-->
    <div id="allocateDiv" class="p-15 tableDisplay">
        <div class=" bg-white p-l-10 p-r-10 b-r-5">
            <table id="allocateTable" class="table table-hover"></table>
        </div>
    </div>
    <div class="container" style="width: 100%;">
        <div id="allocateToolbar">
            <button id="return1" type="button" class="btn btn-default">
                <i class="glyphicon glyphicon-arrow-left"></i> 返回
            </button>
            <button id="allocateBnt" type="button" class="btn btn-default" disabled>
                <i class="glyphicon glyphicon-screenshot"></i> 分配
            </button>
        </div>
    </div>
    <!--退还Table-->
    <div id="giveBackDiv" class="p-15 tableDisplay">
        <div class="bg-white p-l-10 p-r-10 b-r-5">
            <table id="giveBackTable" class="table table-hover"></table>
        </div>
    </div>

    <div class="container" style="width: 100%;">
        <div id="giveBackToolbar">
            <button id="return2" type="button" class="btn btn-default">
                <i class="glyphicon glyphicon-arrow-left"></i> 返回
            </button>
            <button id="giveBackBnt" type="button" class="btn btn-default" disabled>
                <i class="glyphicon glyphicon-log-out"></i> 退还
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
    var Table = {
        api: '/api/bm/outputs',
        tableId: "myTable",
        toolbarId: "toolbar",
        bsTable: null,
        bsModal: null
    };
    Table.initColumn = function () {
        var columns = [
            {field: 'state1', radio: true, align: 'center', valign: 'middle'},
            {title: 'ID', field: 'id', align: 'center', visible: false},
            {title: '出库单号', field: 'outputNo', align: 'center', sortable: true, width: '10%'},
            {title: '仓库名称', field: 'whName', align: 'center'},
            {title: '申请人', field: 'proposer', align: 'center'},
            {title: '审批人', field: 'approver', align: 'center'},
            {title: '班级', field: 'banJiName', align: 'center'},
            {title: '项目', field: 'projectName', align: 'center'},
            {title: '状态', field: 'state', align: 'center', formatter: BSTable.prototype.stateFormatter},
            {title: '备注', field: 'remark', align: 'center'}
        ];
        return columns;
    };

    var AllocateTable = {
        api: '/api/bm/outputs/findInventory',
        tableId: "allocateTable",
        toolbarId: "allocateToolbar",
        bsTable: null,
        bsModal: null
    };
    AllocateTable.initColumn = function () {
        var columns = [
            {field: 'state', checkbox: true, align: 'center', valign: 'middle'},
            {title: 'ID', field: 'id', align: 'center', visible: false},
            {title: '出库单号', field: 'outputNo', align: 'center', sortable: true, width: '10%'},
            {title: '物料名称', field: 'skuDesc', align: 'center', sortable: true},
            {title: '规格/类型', field: 'spec', align: 'center'},
            {title: '仓库名称', field: 'whName', align: 'center'},
            {title: '储位代码', field: 'locName', align: 'center'},
            {title: '库存量', field: 'skuAmount', align: 'center'},
            {
                title: '分配量', field: 'allocateAmount', align: 'center',
                editable: {
                    type: 'text',
                    title: '分配领用量',
                    validate: function (v) {
                        if (!v) return '领用量不能为空';
                    }}
            },
            {title: '申请总量', field: 'outNumber', align: 'center'}
        ];
        return columns;
    };

    var GiveBackTable = {
        api: '',
        tableId: "giveBackTable",
        toolbarId: "giveBackToolbar",
        bsTable: null,
        bsModal: null
    };
    GiveBackTable.initColumn = function () {
        var columns = [
            {field: 'state', checkbox: true, align: 'center', valign: 'middle'},
            {title: 'ID', field: 'id', align: 'center', visible: false},
            {title: '出库单号', field: 'outputNo', align: 'center', sortable: true, width: '10%'},
            {title: '物料名称', field: 'skuDesc', align: 'center'},
            {title: '规格/类型', field: 'spec', align: 'center'},
            {title: '仓库名称', field: 'whName', align: 'center'},
            {title: '储位代码', field: 'locName', align: 'center'},
            {title: '库存量', field: 'skuAmount', align: 'center'},
            {title: '退还量', field: 'returnNumber', align: 'center', editable: true}
        ];
        return columns;
    };

    //执行方法
    $(function () {

        var bsTable = new BSTable(Table.tableId, Table.toolbarId, CSW.getUrl(Table.api), Table.initColumn());
        bsTable = bsTable.init();
        bsTable.tbInstance.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table', function () {
            $("#allocate").prop('disabled', !bsTable.getIdSelections().length);
            $("#giveBack").prop('disabled', !bsTable.getIdSelections().length);
        });
        bsTable.tbInstance.on('refresh.bs.table', function () {
            $("#allocate").prop('disabled', !bsTable.getIdSelections().length);
            $("#giveBack").prop('disabled', !bsTable.getIdSelections().length);
        });

        var allocateTable = new BSTable(AllocateTable.tableId, AllocateTable.toolbarId, CSW.getUrl(AllocateTable.api), AllocateTable.initColumn());
        allocateTable = allocateTable.init();
        allocateTable.tbInstance.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table', function () {
            $("#allocateBnt").prop('disabled', !allocateTable.getIdSelections().length);
        });

        var giveBackTable = new BSTable(GiveBackTable.tableId, GiveBackTable.toolbarId, GiveBackTable.api, GiveBackTable.initColumn());
        giveBackTable = giveBackTable.init();
        giveBackTable.tbInstance.on('check.bs.table uncheck.bs.table ' +
            'check-all.bs.table uncheck-all.bs.table', function () {
            $("#giveBackBnt").prop('disabled', !giveBackTable.getIdSelections().length);
        });

        $("#allocate").click(function () {
            var itemSelections = bsTable.getItemSelections();
            if (itemSelections.length === 1) {
                if (itemSelections[0].state === 3) {
                    var queryData = {};
                    queryData['id'] = parseInt(itemSelections[0].id);
                    allocateTable.refresh({query: queryData});
                    allocateTable.setRefreshParams({query: queryData});
                    $("#allocateDiv").css("display", "block");
                    setTimeout(function () {
                        $("#allocateDiv").css("transform", "translate(0%, -100%)");
                    }, 100)
                } else {
                    CSW.error("只有审批通过的单据才能出库");
                }

            } else if (itemSelections.length > 1) {
                CSW.info(CSW.selectOneTip);
            }
        });
        $('#allocateBnt').click(function () {
            var items = allocateTable.getItemSelections();
            // console.log(items);
            if (items.length > 0) {
                var objects = [];
                for (var i in items) {
                    var obj = {};
                    obj["id"] = items[i].id;
                    obj["outputNo"] = items[i].outputNo;
                    obj["allocateAmount"] = items[i].allocateAmount;
                    objects.push(obj);
                }
                var ajax = new $ax(Table.api + "/allocate", function (data) {
                    if (data.code === "0000") {
                        CSW.success(CSW.saveOk);
                        $("#allocateDiv").css("transform", "translate(0%, 0%)");
                        setTimeout(function () {
                            $("#allocateDiv").css("display", "none");
                        }, 300);
                        bsTable.refresh();
                    } else if (data.code === "0002") {
                        CSW.error(CSW.saveFail + data.msg);
                    } else {
                        CSW.error(CSW.unknowCode + data.code);
                    }
                }, function (data) {
                    CSW.error(CSW.requestFail + data.msg);
                });
                ajax.setData(objects); //提交的Json数据对象
                ajax.type = "POST";
                ajax.start();
            }
        });
        $("#giveBack").click(function () {
            $("#giveBackDiv").css("display", "block");
            setTimeout(function () {
                $("#giveBackDiv").css("transform", "translate(0%, -100%)");
            }, 100);
        });
        $("#return1").click(function () {
            $("#allocateDiv").css("transform", "translate(0%, 0%)");
            setTimeout(function () {
                $("#allocateDiv").css("display", "none");
            }, 300);
        });
        $("#return2").click(function () {
            $("#giveBackDiv").css("transform", "translate(0%, 0%)");
            setTimeout(function () {
                $("#giveBackDiv").css("display", "none");
            }, 300);
        });

    });
</script>
